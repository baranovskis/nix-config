# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

This is a NixOS flake configuration repository that manages both system-wide NixOS configuration and user-specific home-manager configuration. The setup uses the unstable nixpkgs channel and includes various specialized modules for gaming, theming (Stylix), VM tools, and custom packages.

## Common Commands

### System Configuration
```bash
# Rebuild and switch NixOS system configuration
# Activates immediately and makes it the boot default
sudo nixos-rebuild switch --flake .#erebor

# Build and make boot default, but don't activate until reboot
sudo nixos-rebuild boot --flake .#erebor

# Test NixOS configuration without switching
# Activates immediately but reverts on reboot
sudo nixos-rebuild test --flake .#erebor

# Build NixOS configuration without switching
sudo nixos-rebuild build --flake .#erebor

# Show what changes would be made without applying them
sudo nixos-rebuild dry-activate --flake .#erebor

# Build a VM for testing the configuration
sudo nixos-rebuild build-vm --flake .#erebor

# Note: You can also use .#desktop or omit the hostname (defaults to erebor)
# For other hosts, use: --flake .#hostname
```

### Home Manager Configuration
```bash
# Switch home-manager configuration
home-manager switch --flake .

# Build home-manager configuration
home-manager build --flake .
```

### Flake Management
```bash
# Update all flake inputs to latest versions
nix flake update

# Update specific flake input
nix flake lock --update-input <input-name>

# Show flake information
nix flake show

# Check flake for errors
nix flake check

# Show flake metadata
nix flake metadata

# Build specific packages from the flake
nix build .#package-name

# Enter development shell with package
nix shell .#package-name
```

### Generation Management
```bash
# List all system generations
sudo nix-env --list-generations --profile /nix/var/nix/profiles/system

# Rollback to previous generation
sudo nixos-rebuild switch --rollback

# Switch to specific generation
sudo nix-env --profile /nix/var/nix/profiles/system --switch-generation <number>

# Delete old generations (keep last 7 days)
sudo nix-collect-garbage --delete-older-than 7d

# List home-manager generations
home-manager generations

# Remove old home-manager generations
home-manager expire-generations "-7 days"
```

### Git Requirements
All changes must be tracked by git before nix can see them:
```bash
git add .
```

### Simplifying Commands with `just`
This configuration includes [just](https://github.com/casey/just) command runner (installed in `common/packages.nix`) with a Justfile providing shortcuts:

```bash
# Build and switch system configuration
just system

# Build and switch home-manager configuration
just user

# Update flake inputs to latest versions
just update

# Clean old generations (system + home-manager, keeps last 7 days)
just clean
```

The Justfile keeps things stupid simple - just build, update, and cleanup commands.

## Architecture

### Flake Structure
- `flake.nix`: Main flake definition with inputs and outputs
- `flake.lock`: Locked versions of all dependencies

### Host Configurations (`hosts/`)
Per-device hardware and host-specific configurations:
- `erebor/`: Desktop machine configuration (The Lonely Mountain)
  - `default.nix`: Host-specific settings (hostname, boot loader, kernel selection, ACPI params)
  - `hardware.nix`: Auto-detected hardware configuration (generated by nixos-generate-config)
  - `graphics.nix`: Shared GPU configuration (OpenGL/Vulkan, video drivers)
  - `nvidia.nix`: NVIDIA-specific settings (proprietary drivers, modesetting)
  - `radeon.nix`: AMD Radeon driver and VFIO passthrough scripts
  - `vfio.nix`: VFIO GPU passthrough kernel modules and udev rules
  - `gaming.nix`: Gaming configuration (Steam, Wine, Lutris, Heroic, Looking Glass)

**What goes in host configs:**
- Boot loader configuration (systemd-boot, GRUB, etc.)
- Kernel selection (linuxPackages_zen, linuxPackages_latest, etc.)
- Hardware-specific kernel parameters (ACPI overrides, etc.)
- GPU drivers and graphics configuration (NVIDIA/AMD)
- VFIO/GPU passthrough (IOMMU, kernel modules, udev rules, Looking Glass)
- Host-specific gaming configuration (system services + user apps)
- Hardware-specific settings (filesystems, swap, network interfaces)

To add a new host:
1. Create `hosts/hostname/` directory
2. Add `default.nix` with host-specific settings and imports
3. Add `hardware.nix` (copy from `/etc/nixos/hardware-configuration.nix` or run `nixos-generate-config`)
4. Copy or create host-specific modules (GPU drivers, virtualization, gaming, etc.)
5. Add entry to `flake.nix` in `nixosConfigurations`

### Common System Configuration (`common/`)
- `default.nix`: Main system configuration entry point (common across all hosts)
- Modular configuration files organized by category:

**Audio & Peripherals:**
- `audio.nix`: Audio/PipeWire configuration
- `bluetooth.nix`: Bluetooth configuration
- `nuphy.nix`: NuPhy keyboard configuration
- `solaar.nix`: Logitech device management

**Desktop Environment:**
- `gnome.nix`: GNOME desktop environment
- `rdp.nix`: Remote desktop protocol (GNOME RDP support)

**Development & Services:**
- `docker.nix`: Docker containerization
- `nfs.nix`: NFS server/client configuration
- `networking.nix`: Network configuration
- `virtualization.nix`: KVM/QEMU/libvirt (shared VM infrastructure)

**Security:**
- `ssh.nix`: SSH configuration
- `gnupg.nix`: GnuPG configuration

**System:**
- `gc.nix`: Garbage collection settings
- `locale.nix`: Timezone and internationalization settings
- `nix.nix`: Nix daemon and flake configuration
- `packages.nix`: System-wide packages (includes just)
- `power.nix`: Power management settings
- `printing.nix`: CUPS printing service
- `shell.nix`: Shell configuration (Fish)
- `user.nix`: User account definitions

**What goes in common configs:**
- Desktop environments (GNOME, KDE, etc.)
- System-wide services (audio, networking, printing)
- System-level packages and tools
- Virtualization infrastructure (libvirt, QEMU, virt-manager)
- User accounts and permissions
- General system settings (locale, timezone, Nix daemon)

### Home Manager Configuration (`home-manager/`)
Shared user configuration across all hosts:
- `default.nix`: Main home-manager configuration entry point
- `config/`: Desktop environment configurations
  - `default.nix`: Config module imports
  - `dconf.nix`: GNOME dconf settings
- `programs/`: User application configurations
  - `default.nix`: Program module imports
  - `direnv.nix`: direnv with nix-direnv integration
  - `looking-glass.nix`: Looking Glass client configuration
  - `packages.nix`: General user packages (categorized)
- `themes/`: Theming configurations
  - `stylix.nix`: Stylix theme settings and fonts
- `wallpapers/`: System wallpapers

**What goes in shared home-manager:**
- User applications common across all hosts
- Personal development tools
- Shell and terminal configurations
- Application-specific settings (browsers, editors)
- User themes and appearance
- Desktop environment user settings

**Note:** Host-specific user packages (like gaming apps) should be added directly to host configuration files (e.g., `hosts/erebor/gaming.nix`) rather than creating separate home-manager modules per host.

### Custom Packages (`pkgs/`)
- `citron-emu/package.nix`: Custom emulator package
- Packages are exposed via overlays

### Overlays (`overlays/`)
- `default.nix`: Package overlays and modifications

## Key Features

### Theming System
- Uses Stylix for consistent theming across applications
- Base16 color scheme defined in `stylix.yaml`
- Automatic theming for GNOME and other applications

### Multiple Nixpkgs Channels
- `nixpkgs-unstable`: Primary channel for most packages
- `nixpkgs-stable`: Stable channel for specific tools
- Separate versioning allows stability where needed

### Specialized Inputs
- `home-manager`: User environment management
- `stylix`: System-wide theming
- `nix-gaming`: Gaming optimizations
- `nixvirt`: VM management tools
- `zen-browser`: Custom browser package
- `solaar`: Logitech device management

### User Configuration
- Username: `baranovskis`
- Home directory: `/home/baranovskis`
- Default shell: Fish (with Bash available)
- Desktop environment: GNOME with custom theming

## Best Practices

### Security
- **Never put secrets in flake files**: Flake contents are copied to the world-readable Nix store
- Use a secrets management solution (e.g., sops-nix, agenix) for sensitive data
- Keep `.env` files and credentials out of git

### Git Workflow
- **All files must be tracked by git**: Flakes only see files in the git working tree
- Always `git add` new files before running nix commands
- Commit working configurations to maintain history

### Configuration Organization
- Keep related settings in specific module files
- Use descriptive module names that reflect their purpose
- Comment complex configurations for future reference
- Use `default.nix` files as central import points for module groups
- Keep modules focused and single-purpose for better reusability

### Module System Best Practices
- **Import patterns**: Use `imports = [ ./module.nix ];` to split configurations
- **Configuration merging**: Nix intelligently merges lists and attribute sets across modules
- **Override control**: Use library functions for precise configuration control:
  - `lib.mkDefault`: Set default values (priority 1000) - can be overridden
  - `lib.mkForce`: Force specific values (priority 50) - overrides other settings
  - `lib.mkBefore`/`lib.mkAfter`: Control merge order for lists and strings
- **Modularization strategy**:
  - Break large configurations into logical, focused modules
  - Use `hosts/` for machine-specific settings
  - Use `common/` for shared system configuration
  - Use `home-manager/` for user-specific settings
  - Group related modules in subdirectories with a `default.nix` entry point

### System Maintenance
- Run `nix flake update` regularly to get security updates
- Use `nix-collect-garbage` periodically to free disk space
- Keep at least one known-good generation for rollback
- Test configurations with `nixos-rebuild test` before committing

### Performance
- Use `nixpkgs-stable` for critical system components
- Use `nixpkgs-unstable` for desktop applications and development tools
- Pin important package versions in `flake.lock`

## Development Workflow

1. Make changes to configuration files
2. Add files to git: `git add .`
3. Check for errors: `nix flake check`
4. Test changes: `sudo nixos-rebuild test --flake .#erebor` or `home-manager build --flake .`
5. Apply changes: `sudo nixos-rebuild switch --flake .#erebor` or `home-manager switch --flake .`
6. Update dependencies periodically: `nix flake update`
7. Clean up old generations: `sudo nix-collect-garbage --delete-older-than 7d`

### Adding a New Host

1. Generate hardware configuration on the new machine:
   ```bash
   sudo nixos-generate-config --show-hardware-config > hardware.nix
   ```
2. Create `hosts/hostname/` directory in your flake repository
3. Move the generated `hardware.nix` to `hosts/hostname/`
4. Create `hosts/hostname/default.nix` with host-specific settings (hostname, etc.)
5. Add the new host to `flake.nix` under `nixosConfigurations`
6. Deploy: `sudo nixos-rebuild switch --flake .#hostname`

## Troubleshooting

### Common Issues

**Nix can't find files:**
- Ensure all files are tracked in git: `git add .`
- Check that you're in the repository root directory

**Packages are outdated or missing:**
- Update flake inputs: `nix flake update`
- Check if package exists: `nix search nixpkgs <package-name>`
- Verify the correct nixpkgs channel is being used

**Build failures:**
- Check build logs: `journalctl -xe`
- Verify syntax: `nix flake check`
- Try building without switching: `sudo nixos-rebuild build --flake .`

**System won't boot:**
- Boot into previous generation from GRUB menu
- Rollback: `sudo nixos-rebuild switch --rollback`
- Check hardware configuration in `hardware.nix`

**Disk space issues:**
- List generations: `sudo nix-env --list-generations --profile /nix/var/nix/profiles/system`
- Remove old generations: `sudo nix-collect-garbage --delete-older-than 7d`
- Deep clean: `sudo nix-collect-garbage -d` (removes all old generations)

**Home-manager conflicts:**
- Check for conflicting package definitions between system and home-manager
- Rebuild home-manager separately: `home-manager switch --flake .`
- Check home-manager logs: `journalctl --user -xe`

**Flake evaluation errors:**
- Check syntax errors in nix files
- Verify all inputs are properly defined in `flake.nix`
- Update flake lock: `nix flake lock --recreate-lock-file`

**Graphics driver issues:**
- Verify correct driver module is enabled (`nvidia.nix` or `radeon.nix`)
- Check kernel module loading: `lsmod | grep -E 'nvidia|amdgpu'`
- Review Xorg logs: `journalctl -b | grep -i 'x11\|xorg'`

## Resources

### Official Documentation
- [NixOS Manual](https://nixos.org/manual/nixos/stable/) - Complete NixOS system documentation
- [Nixpkgs Manual](https://nixos.org/manual/nixpkgs/stable/) - Package management documentation
- [Nix Package Search](https://search.nixos.org/) - Search for packages and options
- [Home Manager Manual](https://nix-community.github.io/home-manager/) - Home Manager documentation
- [Home Manager Options](https://nix-community.github.io/home-manager/options.xhtml) - All available configuration options

### Flakes Resources
- [NixOS Wiki - Flakes](https://wiki.nixos.org/wiki/Flakes) - Official flakes documentation
- [NixOS & Flakes Book](https://nixos-and-flakes.thiscute.world/) - Comprehensive beginner's guide
- [Nix Flakes Best Practices](https://nixos-and-flakes.thiscute.world/best-practices/intro) - Recommended patterns

### Community Resources
- [NixOS Discourse](https://discourse.nixos.org/) - Community forum for help and discussions
- [NixOS Wiki](https://wiki.nixos.org/) - Community-maintained documentation
- [Nix Starter Configs](https://github.com/Misterio77/nix-starter-configs) - Example configurations

### This Configuration
- Target NixOS version: unstable (25.05)
- Home Manager: Following nixpkgs-unstable
- Flakes: Enabled (experimental feature)